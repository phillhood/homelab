---
- name: Install Pterodactyl Panel and Wings
  hosts: game_servers
  become: true
  vars:
    pterodactyl_dir: /opt/pterodactyl
    panel_domain: "pterodactyl.home.{{ home_domain }}"
    db_password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"
    app_key: ""  # Generated during setup

  tasks:
    - name: Create Pterodactyl directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ pterodactyl_dir }}"
        - "{{ pterodactyl_dir }}/panel"
        - "{{ pterodactyl_dir }}/wings"
        - "{{ pterodactyl_dir }}/certs"

    - name: Create Panel docker-compose.yml
      copy:
        dest: "{{ pterodactyl_dir }}/panel/docker-compose.yml"
        mode: "0644"
        content: |
          services:
            database:
              image: mariadb:10.11
              restart: always
              command: --default-authentication-plugin=mysql_native_password
              volumes:
                - ./database:/var/lib/mysql
              environment:
                MYSQL_PASSWORD: "{{ db_password }}"
                MYSQL_ROOT_PASSWORD: "{{ db_password }}"
                MYSQL_DATABASE: panel
                MYSQL_USER: pterodactyl

            cache:
              image: redis:alpine
              restart: always

            panel:
              image: ghcr.io/pterodactyl/panel:latest
              restart: always
              ports:
                - "80:80"
                - "443:443"
              links:
                - database
                - cache
              volumes:
                - ./var:/app/var
                - ./nginx:/etc/nginx/http.d
                - ./certs:/etc/letsencrypt
                - ./logs:/app/storage/logs
              environment:
                APP_URL: "https://{{ panel_domain }}"
                APP_TIMEZONE: "America/Toronto"
                APP_SERVICE_AUTHOR: "admin@pterodactyl.local"
                MAIL_FROM: "noreply@pterodactyl.local"
                MAIL_DRIVER: "log"
                DB_PASSWORD: "{{ db_password }}"
                APP_ENVIRONMENT_ONLY: "false"
                CACHE_DRIVER: "redis"
                SESSION_DRIVER: "redis"
                QUEUE_DRIVER: "redis"
                REDIS_HOST: "cache"
                DB_HOST: "database"
                TRUSTED_PROXIES: "*"

    - name: Create Wings docker-compose.yml
      copy:
        dest: "{{ pterodactyl_dir }}/wings/docker-compose.yml"
        mode: "0644"
        content: |
          services:
            wings:
              image: ghcr.io/pterodactyl/wings:latest
              restart: always
              network_mode: host
              tty: true
              environment:
                TZ: "America/Toronto"
                WINGS_UID: 988
                WINGS_GID: 988
                WINGS_USERNAME: pterodactyl
              volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - /var/lib/docker/containers:/var/lib/docker/containers
                - /etc/pterodactyl:/etc/pterodactyl
                - /var/lib/pterodactyl:/var/lib/pterodactyl
                - /var/log/pterodactyl:/var/log/pterodactyl
                - /tmp/pterodactyl:/tmp/pterodactyl
                - /etc/ssl/certs:/etc/ssl/certs:ro

    - name: Create Wings directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - /etc/pterodactyl
        - /var/lib/pterodactyl
        - /var/lib/pterodactyl/volumes
        - /var/lib/pterodactyl/backups
        - /var/log/pterodactyl
        - /tmp/pterodactyl

    - name: Start Panel containers
      community.docker.docker_compose_v2:
        project_src: "{{ pterodactyl_dir }}/panel"
        state: present
      register: panel_output

    - name: Wait for Panel to be ready
      wait_for:
        port: 80
        delay: 10
        timeout: 120

    - name: Display setup instructions
      debug:
        msg:
          - "=============================================="
          - "Pterodactyl Panel is starting!"
          - "=============================================="
          - ""
          - "1. Access the panel at: https://{{ panel_domain }}"
          - "   (You may need to add DNS record first)"
          - ""
          - "2. Create admin user:"
          - "   cd {{ pterodactyl_dir }}/panel"
          - "   docker compose exec panel php artisan p:user:make"
          - ""
          - "3. Configure Wings in Panel UI:"
          - "   - Go to Admin > Nodes > Create New"
          - "   - FQDN: {{ ansible_host }}"
          - "   - Download config to /etc/pterodactyl/config.yml"
          - ""
          - "4. Start Wings:"
          - "   cd {{ pterodactyl_dir }}/wings"
          - "   docker compose up -d"
          - ""
          - "Database password: {{ db_password }}"
          - "=============================================="
