---
- name: Install Pelican Panel and Wings
  hosts: game_servers
  become: true
  vars:
    pelican_dir: /opt/pelican
    panel_domain: "pelican.home.{{ home_domain }}"
    wings_domain: "wings.home.{{ home_domain }}"

  tasks:
    - name: Ensure docker is installed
      ansible.builtin.command: docker --version
      register: docker_check
      changed_when: false
      failed_when: docker_check.rc != 0

    - name: Create Pelican directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ pelican_dir }}"
        - "{{ pelican_dir }}/panel"
        - "{{ pelican_dir }}/wings"
        - /etc/pelican
        - /var/lib/pelican
        - /var/lib/pelican/volumes
        - /var/lib/pelican/backups
        - /var/log/pelican
        - /tmp/pelican

    - name: Copy Panel docker-compose
      ansible.builtin.copy:
        src: ../../../docker/pelican/panel/docker-compose.yaml
        dest: "{{ pelican_dir }}/panel/docker-compose.yaml"
        mode: "0644"
      notify: Restart panel

    - name: Copy Wings docker-compose
      ansible.builtin.copy:
        src: ../../../docker/pelican/wings/docker-compose.yaml
        dest: "{{ pelican_dir }}/wings/docker-compose.yaml"
        mode: "0644"

    - name: Create Panel .env file
      ansible.builtin.copy:
        dest: "{{ pelican_dir }}/panel/.env"
        mode: "0600"
        content: |
          APP_URL=https://{{ panel_domain }}
        force: false

    - name: Create Panel systemd service
      ansible.builtin.copy:
        dest: /etc/systemd/system/pelican-panel.service
        mode: "0644"
        content: |
          [Unit]
          Description=Pelican Panel (docker-compose)
          Requires=docker.service
          After=docker.service

          [Service]
          Type=oneshot
          RemainAfterExit=yes
          WorkingDirectory={{ pelican_dir }}/panel
          ExecStart=/usr/bin/docker compose up -d
          ExecStop=/usr/bin/docker compose down

          [Install]
          WantedBy=multi-user.target
      notify: Reload systemd

    - name: Create Wings systemd service
      ansible.builtin.copy:
        dest: /etc/systemd/system/pelican-wings.service
        mode: "0644"
        content: |
          [Unit]
          Description=Pelican Wings (docker-compose)
          Requires=docker.service
          After=docker.service pelican-panel.service

          [Service]
          Type=oneshot
          RemainAfterExit=yes
          WorkingDirectory={{ pelican_dir }}/wings
          ExecStart=/usr/bin/docker compose up -d
          ExecStop=/usr/bin/docker compose down

          [Install]
          WantedBy=multi-user.target
      notify: Reload systemd

    - name: Enable and start Panel service
      ansible.builtin.systemd:
        name: pelican-panel
        state: started
        enabled: true
        daemon_reload: true

    - name: Wait for Panel to be ready
      ansible.builtin.wait_for:
        port: 80
        delay: 10
        timeout: 120

    - name: Display setup instructions
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "Pelican Panel is running!"
          - "=============================================="
          - ""
          - "1. Access installer at: https://{{ panel_domain }}/installer"
          - "   Complete the web-based setup wizard"
          - ""
          - "2. After setup, create a Node in the Panel:"
          - "   - FQDN: {{ wings_domain }}"
          - "   - Communicate over SSL: OFF (Panel connects directly via HTTP)"
          - "   - Behind Proxy: ON (browser uses HTTPS via Traefik)"
          - "   - Daemon Port: 8080"
          - ""
          - "3. Copy Wings config to /etc/pelican/config.yml"
          - "   Then enable Wings:"
          - "   sudo systemctl enable --now pelican-wings"
          - ""
          - "4. Update Wings trusted_proxies in /etc/pelican/config.yml:"
          - "   trusted_proxies:"
          - "     - 192.168.2.100"
          - "     - 10.42.0.0/16"
          - "=============================================="

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart panel
      ansible.builtin.shell:
        cmd: docker compose up -d --force-recreate
        chdir: "{{ pelican_dir }}/panel"
