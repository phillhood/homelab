---
- name: Setup Pi-hole docker-compose systemd service
  hosts: control_plane
  become: true
  vars:
    pihole_compose_dir: "{{ homelab_dir }}/docker/pihole"

  tasks:
    - name: Ensure docker is installed
      ansible.builtin.command: docker --version
      register: docker_check
      changed_when: false
      failed_when: docker_check.rc != 0

    - name: Create Pi-hole systemd service
      ansible.builtin.copy:
        dest: /etc/systemd/system/pihole.service
        mode: "0644"
        content: |
          [Unit]
          Description=Pi-hole DNS (docker-compose)
          Requires=docker.service
          After=docker.service

          [Service]
          Type=oneshot
          RemainAfterExit=yes
          WorkingDirectory={{ pihole_compose_dir }}
          ExecStart=/usr/bin/docker compose up -d
          ExecStop=/usr/bin/docker compose down

          [Install]
          WantedBy=multi-user.target
      notify: Reload systemd

    - name: Enable and start Pi-hole service
      ansible.builtin.systemd:
        name: pihole
        state: started
        enabled: true
        daemon_reload: true

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true
