---
- name: Setup kubeconfig for user
  hosts: control_plane
  become: true
  vars:
    kubeconfig_user: "{{ lookup('env', 'USER') }}"
    kubeconfig_dir: "{{ lookup('env', 'HOME') }}/.kube"

  tasks:
    - name: Create .kube directory
      ansible.builtin.file:
        path: "{{ kubeconfig_dir }}"
        state: directory
        owner: "{{ kubeconfig_user }}"
        mode: "0700"

    - name: Copy kubeconfig to user directory
      ansible.builtin.copy:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "{{ kubeconfig_dir }}/config"
        remote_src: true
        owner: "{{ kubeconfig_user }}"
        mode: "0600"

    - name: Update kubeconfig server address
      ansible.builtin.replace:
        path: "{{ kubeconfig_dir }}/config"
        regexp: 'https://127.0.0.1:6443'
        replace: 'https://{{ ansible_host }}:6443'
      when: ansible_host != 'localhost'

    - name: Test kubectl
      ansible.builtin.command: kubectl get nodes
      become: false
      register: kubectl_test
      changed_when: false

    - name: Show cluster status
      ansible.builtin.debug:
        msg: "{{ kubectl_test.stdout_lines }}"
